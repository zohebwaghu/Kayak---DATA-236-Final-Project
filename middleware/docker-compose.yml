version: '3.8'

services:
  # ==================== MESSAGE QUEUE ====================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: kayak-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - kayak-network
    healthcheck:
      test: [ "CMD", "zkServer.sh", "status" ]
      interval: 30s
      timeout: 10s
      retries: 3

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kayak-kafka
    depends_on:
      - zookeeper
    ports:
      - "9094:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9093,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - kayak-network
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== CACHE ====================

  redis:
    image: redis:7-alpine
    container_name: kayak-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - kayak-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== DATABASES ====================

  mysql:
    image: mysql:8.0
    container_name: kayak-mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: kayak_users
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/mysql-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - kayak-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword" ]
      interval: 30s
      timeout: 10s
      retries: 5

  mongodb:
    image: mongo:7.0
    container_name: kayak-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - kayak-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==================== MICROSERVICES ====================

  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    container_name: kayak-api-gateway
    ports:
      - "3000:3000"
    environment:
      API_GATEWAY_PORT: 3000
      JWT_SECRET: super-secret-key-change-in-production
      JWT_EXPIRY: 24h
      USER_SERVICE_PORT: 3001
      SEARCH_SERVICE_PORT: 3003
      BOOKING_SERVICE_PORT: 3004
      LISTINGS_SERVICE_PORT: 3002
      BILLING_SERVICE_PORT: 3005
      ADMIN_SERVICE_PORT: 3006
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 100000
      NODE_ENV: production
    depends_on:
      - user-service
      - search-service
      - booking-service
    networks:
      - kayak-network
    restart: unless-stopped

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: kayak-user-service
    ports:
      - "3001:3001"
    environment:
      USER_SERVICE_PORT: 3001
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: password
      MYSQL_DB_USERS: kayak_users
      KAFKA_BROKER: kafka:9093
      KAFKA_CLIENT_ID: user-service
      JWT_SECRET: super-secret-key-change-in-production
      JWT_EXPIRY: 24h
      NODE_ENV: production
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - kayak-network
    restart: unless-stopped

  search-service:
    build:
      context: .
      dockerfile: ./services/search-service/Dockerfile
    container_name: kayak-search-service
    ports:
      - "3003:3003"
    environment:
      SEARCH_SERVICE_PORT: 3003
      MONGO_URI: mongodb://mongodb:27017
      # ðŸ”´ Was kayak_search, but you inserted data into kayak_doc
      MONGO_DB_SEARCH: kayak_doc
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_TTL: 300
      KAFKA_BROKER: kafka:9093
      KAFKA_CLIENT_ID: search-service
      NODE_ENV: production
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - kayak-network
    restart: unless-stopped

  booking-service:
    build:
      context: .
      dockerfile: ./services/booking-service/Dockerfile
    container_name: kayak-booking-service
    ports:
      - "3004:3004"
    environment:
      BOOKING_SERVICE_PORT: 3004
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: password
      MYSQL_DB_BOOKINGS: kayak_bookings
      KAFKA_BROKER: kafka:9093
      KAFKA_CLIENT_ID: booking-service
      NODE_ENV: production
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - kayak-network
    restart: unless-stopped

  # ==================== AI SERVICE ====================

  ai-service:
    build:
      context: ../ai
      dockerfile: Dockerfile
    container_name: kayak-ai-service
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=
      - OPENAI_MODEL=gpt-3.5-turbo
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_EMBEDDING_MODEL=mxbai-embed-large
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9093
      - KAFKA_CONSUMER_GROUP=ai-deals-agent
      - KAFKA_DEALS_RAW_TOPIC=raw_supplier_feeds
      - KAFKA_DEALS_NORMALIZED_TOPIC=deals.normalized
      - KAFKA_DEALS_SCORED_TOPIC=deals.scored
      - KAFKA_DEALS_TAGGED_TOPIC=deals.tagged
      - KAFKA_DEAL_EVENTS_TOPIC=deal.events
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=password
      - DB_NAME_USERS=kayak_users
      - DB_NAME_BOOKINGS=kayak_bookings
      - MONGO_URI=mongodb://mongodb:27017
      - MONGO_DB=kayak_doc
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_ENV=production
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001
    volumes:
      - ../data:/data
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - kayak-network
    restart: unless-stopped

# ==================== NETWORKS ====================

networks:
  kayak-network:
    driver: bridge

# ==================== VOLUMES ====================

volumes:
  mysql-data:
    driver: local
  mongo-data:
    driver: local
  redis-data:
    driver: local
